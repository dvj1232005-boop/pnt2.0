<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Partner Treat System</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#020617">

<style>
:root{
  --bg:#020617;--card:#020617e6;--border:#1e293b;
  --text:#e5e7eb;--muted:#94a3b8;
  --accent:#22c55e;--danger:#ef4444;--info:#38bdf8;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  background:linear-gradient(180deg,#020617,#0f172a);
  color:var(--text);min-height:100vh;
}
.hidden{display:none}
.container{max-width:420px;margin:auto;padding:24px}
.card{
  background:var(--card);border-radius:20px;padding:22px;
  box-shadow:0 20px 40px rgba(0,0,0,.45);
  border:1px solid var(--border);
}
h1,h2,h3{margin:0 0 12px}
small{color:var(--muted)}
input,select,textarea,button{
  width:100%;padding:14px;margin-top:12px;
  border-radius:14px;font-size:16px;
  background:#020617;color:var(--text);
  border:1px solid var(--border);
}
button{
  background:linear-gradient(90deg,var(--accent),#16a34a);
  color:#022c22;font-weight:700;border:none;
}
button.secondary{
  background:linear-gradient(90deg,var(--info),#0ea5e9);
}
button.danger{
  background:linear-gradient(90deg,var(--danger),#b91c1c);
  color:#fff;
}
.code{
  padding:12px;background:#020617;border-radius:12px;
  margin-bottom:8px;border:1px dashed var(--border);
  text-align:center;letter-spacing:1px;
}
footer{
  margin-top:26px;text-align:center;
  font-size:12px;color:var(--muted);line-height:1.5;
}
</style>
</head>
<body>

<div class="container">

<div class="card" id="roleSelect">
  <h1>Partner Treat System</h1>
  <small id="periodText"></small>
  <button class="secondary" onclick="show('employeeLogin')">
    Truy cập dành cho Nhân viên
  </button>
  <button class="secondary" onclick="show('adminLogin')">
    Truy cập dành cho Quản lý
  </button>
</div>

<div class="card hidden" id="employeeLogin">
  <h2>Xác thực nhân viên</h2>
  <input id="empName" placeholder="Họ và tên nhân viên">
  <select id="empType">
    <option value="">Loại hình làm việc</option>
    <option value="fulltime">Nhân viên Full-time</option>
    <option value="parttime">Nhân viên Part-time</option>
  </select>
  <input id="empPin" type="password" placeholder="Mã PIN cá nhân">
  <button onclick="loginEmployee()">Xác nhận & Truy cập</button>
  <button class="danger" onclick="back()">Huỷ & Quay lại</button>
</div>

<div class="card hidden" id="employeeView">
  <h2 id="empTitle"></h2>
  <small>Mã Partner Treat cho kỳ hiện tại</small>
  <div id="empCodes"></div>
  <button class="danger" onclick="back()">Đăng xuất</button>
</div>

<div class="card hidden" id="adminLogin">
  <h2>Xác thực quản lý</h2>
  <input id="adminPin" type="password" placeholder="Mã PIN quản lý">
  <button onclick="loginAdmin()">Vào bảng điều phối</button>
  <button class="danger" onclick="back()">Huỷ & Quay lại</button>
</div>

<div class="card hidden" id="adminPanel">
  <h2>Bảng điều phối Partner Treat</h2>
  <small>Dán danh sách mã gốc (mỗi dòng 1 mã)</small>
  <textarea id="sourceCodes" rows="7"></textarea>
  <button onclick="distribute()">Phân bổ mã tự động</button>
  <div id="adminResult"></div>
  <button class="danger" onclick="back()">Đăng xuất quản lý</button>
</div>

<footer>
  © 2025 Partner Treat System<br>
  Phát triển bởi <strong>Đào Đăng Tùng</strong>
</footer>

</div>

<script>
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}

/* ===== DATA ===== */
const baseEmployees=[
 {name:"Nguyễn Minh Hiếu",type:"fulltime",pin:"1111",need:10},
 {name:"Nguyễn Phương Anh",type:"fulltime",pin:"2222",need:10},
 {name:"Đào Đăng Tùng",type:"parttime",pin:"3333",need:5},
 {name:"Chu Thùy Linh",type:"parttime",pin:"4444",need:5}
];

const now=new Date();
const currentPeriod=`${now.getFullYear()}-${now.getMonth()+1}`;
document.getElementById("periodText").innerText="Kỳ áp dụng: "+currentPeriod;

let data=JSON.parse(localStorage.getItem("partnerTreat"));
if(!data||data.period!==currentPeriod){
 data={period:currentPeriod,locked:false,
 employees:baseEmployees.map(e=>({...e,codes:[]}))};
 localStorage.setItem("partnerTreat",JSON.stringify(data));
}

/* ===== UI ===== */
function show(id){
 ["roleSelect","employeeLogin","employeeView","adminLogin","adminPanel"]
 .forEach(v=>document.getElementById(v).classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
}
function back(){show("roleSelect")}

/* ===== LOGIN EMPLOYEE ===== */
function loginEmployee(){
 const name=document.getElementById("empName").value.trim().toLowerCase();
 const type=document.getElementById("empType").value;
 const pin=document.getElementById("empPin").value;
 const emp=data.employees.find(e=>e.name.toLowerCase()===name);

 if(!emp||emp.type!==type||emp.pin!==pin){
  alert("Thông tin xác thực không hợp lệ");return;
 }
 if(!emp.codes.length){
  alert("Kỳ này chưa được phân bổ Partner Treat");return;
 }

 show("employeeView");
 document.getElementById("empTitle").innerText=`${emp.name} (${emp.type})`;
 const box=document.getElementById("empCodes");
 box.innerHTML="";
 emp.codes.forEach(c=>{
  const d=document.createElement("div");
  d.className="code";d.innerText=c;
  box.appendChild(d);
 });
}

/* ===== LOGIN ADMIN ===== */
function loginAdmin(){
 const pin=document.getElementById("adminPin").value;
 if(pin!=="2005"){alert("Mã PIN quản lý không đúng");return;}
 show("adminPanel");
 if(data.locked) showAdminResult();
}

/* ===== DISTRIBUTE ===== */
function distribute(){
 if(data.locked){alert("Kỳ này đã phân bổ");return;}
 const raw=document.getElementById("sourceCodes").value;
 let codes=[...new Set(raw.split(/\n+/).map(c=>c.trim()).filter(Boolean))];
 const need=data.employees.reduce((s,e)=>s+e.need,0);
 if(codes.length<need){alert("Số lượng mã không đủ");return;}

 for(let i=codes.length-1;i>0;i--){
  const j=Math.floor(Math.random()*(i+1));
  [codes[i],codes[j]]=[codes[j],codes[i]];
 }

 let idx=0;
 data.employees.forEach(e=>{
  e.codes=codes.slice(idx,idx+e.need);
  idx+=e.need;
 });

 data.locked=true;
 localStorage.setItem("partnerTreat",JSON.stringify(data));
 showAdminResult();
}

function showAdminResult(){
 const box=document.getElementById("adminResult");
 box.innerHTML="";
 data.employees.forEach(e=>{
  const h=document.createElement("h3");
  h.innerText=`${e.name} (${e.type})`;
  box.appendChild(h);
  e.codes.forEach(c=>{
   const d=document.createElement("div");
   d.className="code";d.innerText=c;
   box.appendChild(d);
  });
 });
}
</script>

</body>
</html>
