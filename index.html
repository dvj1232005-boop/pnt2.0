<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Partner Treat System</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#020617">

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  background:#020617;
  color:#e5e7eb;
}
.hidden{display:none}
.container{max-width:420px;margin:auto;padding:24px}
.card{
  background:#020617e6;
  border-radius:18px;
  padding:22px;
  border:1px solid #1e293b;
}
button,input,select,textarea{
  width:100%;margin-top:12px;padding:14px;
  border-radius:12px;font-size:16px;
}
button{background:#22c55e;border:none;font-weight:700}
button.danger{background:#ef4444;color:#fff}
.code{
  padding:10px;border:1px dashed #334155;
  margin-bottom:6px;text-align:center;
}
footer{
  text-align:center;margin-top:24px;
  font-size:12px;color:#94a3b8;
}
</style>
</head>
<body>

<div class="container">

<div class="card" id="home">
  <h2>Partner Treat System</h2>
  <div id="period"></div>
  <button onclick="show('empLogin')">Nhân viên</button>
  <button onclick="show('adminLogin')">Quản lý</button>
</div>

<div class="card hidden" id="empLogin">
  <input id="empName" placeholder="Tên nhân viên">
  <select id="empType">
    <option value="">Loại</option>
    <option value="fulltime">Full-time</option>
    <option value="parttime">Part-time</option>
  </select>
  <input id="empPin" placeholder="PIN">
  <button onclick="loginEmployee()">Truy cập</button>
  <button class="danger" onclick="back()">Quay lại</button>
</div>

<div class="card hidden" id="empView">
  <h3 id="empTitle"></h3>
  <div id="empCodes"></div>
  <button class="danger" onclick="back()">Đăng xuất</button>
</div>

<div class="card hidden" id="adminLogin">
  <input id="adminPin" placeholder="PIN quản lý">
  <button onclick="loginAdmin()">Vào hệ thống</button>
  <button class="danger" onclick="back()">Quay lại</button>
</div>

<div class="card hidden" id="adminPanel">
  <textarea id="codesInput" rows="7"
  placeholder="Mỗi dòng 1 mã"></textarea>
  <button onclick="distribute()">Phân bổ</button>
  <div id="adminResult"></div>
  <button class="danger" onclick="back()">Đăng xuất</button>
</div>

<footer>
© 2025 Partner Treat System<br>
Developed by <b>Đào Đăng Tùng</b>
</footer>

</div>

<script>
/* ===== PERIOD ===== */
const now = new Date();
const periodKey = `${now.getFullYear()}-${now.getMonth()+1}`;
document.getElementById("period").innerText = "Kỳ: " + periodKey;

/* ===== INIT DATA (KHÔNG GHI ĐÈ) ===== */
let data = JSON.parse(localStorage.getItem("partnerTreat"));

if(!data || data.period !== periodKey){
  data = {
    period: periodKey,
    status: "new",
    employees: [
      {name:"Nguyễn Minh Hiếu",type:"fulltime",pin:"1111",need:10,codes:[]},
      {name:"Nguyễn Phương Anh",type:"fulltime",pin:"2222",need:10,codes:[]},
      {name:"Đào Đăng Tùng",type:"parttime",pin:"3333",need:5,codes:[]},
      {name:"Chu Thùy Linh",type:"parttime",pin:"4444",need:5,codes:[]}
    ]
  };
  localStorage.setItem("partnerTreat",JSON.stringify(data));
}

/* ===== UI ===== */
function show(id){
 ["home","empLogin","empView","adminLogin","adminPanel"]
 .forEach(v=>document.getElementById(v).classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
}
function back(){show("home")}

/* ===== EMP ===== */
function loginEmployee(){
 const name=empName.value.trim().toLowerCase();
 const type=empType.value;
 const pin=empPin.value;
 const emp=data.employees.find(e=>e.name.toLowerCase()===name);

 if(!emp||emp.type!==type||emp.pin!==pin){
  alert("Thông tin không đúng");return;
 }
 if(!emp.codes.length){
  alert("Chưa được cấp Partner Treat");return;
 }

 show("empView");
 empTitle.innerText=emp.name;
 empCodes.innerHTML="";
 emp.codes.forEach(c=>{
  const d=document.createElement("div");
  d.className="code";d.innerText=c;
  empCodes.appendChild(d);
 });
}

/* ===== ADMIN ===== */
function loginAdmin(){
 if(adminPin.value!=="2005"){alert("Sai PIN");return;}
 show("adminPanel");
 if(data.status==="distributed") renderAdmin();
}

function distribute(){
 if(data.status==="distributed"){
  alert("Đã phân bổ cho kỳ này");return;
 }

 let codes=[...new Set(
  codesInput.value.split(/\n+/).map(c=>c.trim()).filter(Boolean)
 )];

 const need=data.employees.reduce((s,e)=>s+e.need,0);
 if(codes.length<need){
  alert("Không đủ mã");return;
 }

 for(let i=codes.length-1;i>0;i--){
  const j=Math.floor(Math.random()*(i+1));
  [codes[i],codes[j]]=[codes[j],codes[i]];
 }

 let idx=0;
 data.employees.forEach(e=>{
  e.codes=codes.slice(idx,idx+e.need);
  idx+=e.need;
 });

 data.status="distributed";
 data.distributedAt=Date.now();
 localStorage.setItem("partnerTreat",JSON.stringify(data));
 renderAdmin();
}

function renderAdmin(){
 adminResult.innerHTML="";
 data.employees.forEach(e=>{
  const h=document.createElement("h4");
  h.innerText=e.name;
  adminResult.appendChild(h);
  e.codes.forEach(c=>{
   const d=document.createElement("div");
   d.className="code";d.innerText=c;
   adminResult.appendChild(d);
  });
 });
}
</script>

</body>
</html>

