<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Partner Treat System</title>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  background:linear-gradient(180deg,#020617,#0f172a);
  color:#e5e7eb;
}
.hidden{display:none}
.container{max-width:420px;margin:auto;padding:24px}
.card{
  background:#020617e6;
  border-radius:18px;
  padding:22px;
  border:1px solid #1e293b;
}
input,select,textarea,button{
  width:100%;margin-top:12px;padding:14px;
  border-radius:12px;font-size:16px;
}
button{background:#22c55e;border:none;font-weight:700}
button.danger{background:#ef4444;color:#fff}
button:disabled{background:#334155;color:#94a3b8}
.code{
  padding:10px;border:1px dashed #334155;
  margin-bottom:6px;text-align:center;
}
footer{
  text-align:center;margin-top:24px;
  font-size:12px;color:#94a3b8;
}
</style>
</head>
<body>

<div class="container">

<div class="card" id="home">
  <h2>Partner Treat System</h2>
  <div id="period">Äang táº£i dá»¯ liá»‡uâ€¦</div>
  <button id="empBtn" disabled onclick="show('empLogin')">NhÃ¢n viÃªn</button>
  <button id="adminBtn" disabled onclick="show('adminLogin')">Quáº£n lÃ½</button>
</div>

<div class="card hidden" id="empLogin">
  <input id="empName" placeholder="TÃªn nhÃ¢n viÃªn">
  <select id="empType">
    <option value="">Loáº¡i</option>
    <option value="fulltime">Full-time</option>
    <option value="parttime">Part-time</option>
  </select>
  <input id="empPin" type="password" placeholder="PIN">
  <button onclick="loginEmployee()">Xem Partner Treat</button>
  <button class="danger" onclick="back()">Quay láº¡i</button>
</div>

<div class="card hidden" id="empView">
  <h3 id="empTitle"></h3>
  <div id="empCodes"></div>
  <button id="confirmBtn" onclick="confirmReceived()" disabled>
    XÃ¡c nháº­n Ä‘Ã£ nháº­n
  </button>
  <button class="danger" onclick="back()">ÄÄƒng xuáº¥t</button>
</div>

<div class="card hidden" id="adminLogin">
  <input id="adminPin" type="password" placeholder="PIN quáº£n lÃ½">
  <button onclick="loginAdmin()">VÃ o há»‡ thá»‘ng</button>
  <button class="danger" onclick="back()">Quay láº¡i</button>
</div>

<div class="card hidden" id="adminPanel">
  <textarea id="codesInput" rows="7" placeholder="Má»—i dÃ²ng 1 mÃ£"></textarea>
  <button id="distributeBtn" disabled onclick="distribute()">PhÃ¢n bá»• mÃ£</button>
  <div id="adminResult"></div>
  <button class="danger" onclick="back()">ÄÄƒng xuáº¥t</button>
</div>

<footer>
Â© 2025 Partner Treat System<br>
PhÃ¡t triá»ƒn bá»Ÿi <b>ÄÃ o ÄÄƒng TÃ¹ng</b>
</footer>

</div>

<script>
/* ================== GITHUB CONFIG ================== */
const GITHUB_OWNER = "dvj1232005-boop";
const GITHUB_REPO  = "pnt2.0";
const GITHUB_FILE  = "data.json";

/* ğŸ”´ DÃN TOKEN Cá»¦A Báº N VÃ€O ÄÃ‚Y */
const GITHUB_TOKEN = "DAN_TOKEN_CUA_BAN_VAO_DAY";

/* ================== STATE ================== */
let data = null;
let fileSha = null;
let ready = false;

/* ================== LOAD DATA ================== */
async function loadData(){
  const res = await fetch(
    `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE}`,
    { headers:{ Authorization:`token ${GITHUB_TOKEN}` } }
  );

  if(!res.ok) throw new Error("KhÃ´ng táº£i Ä‘Æ°á»£c dá»¯ liá»‡u GitHub");

  const json = await res.json();
  fileSha = json.sha;
  data = JSON.parse(atob(json.content));

  await autoResetMonth();

  document.getElementById("period").innerText = "Ká»³: " + data.period;
  empBtn.disabled = false;
  adminBtn.disabled = false;
  distributeBtn.disabled = false;
  ready = true;
}

/* ================== AUTO RESET MONTH ================== */
async function autoResetMonth(){
  const now = new Date();
  const currentPeriod = `${now.getFullYear()}-${now.getMonth()+1}`;

  if(data.period !== currentPeriod){
    data.period = currentPeriod;
    data.status = "new";
    data.employees.forEach(e=>{
      e.codes = [];
      e.received = false;
      e.receivedAt = null;
    });
    await saveToGitHub("Tá»± Ä‘á»™ng reset sang ká»³ " + currentPeriod);
  }
}

/* ================== SAVE TO GITHUB ================== */
async function saveToGitHub(message){
  const content = btoa(unescape(encodeURIComponent(
    JSON.stringify(data, null, 2)
  )));

  const res = await fetch(
    `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE}`,
    {
      method: "PUT",
      headers:{
        Authorization: `token ${GITHUB_TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message,
        content,
        sha: fileSha
      })
    }
  );

  if(!res.ok) throw new Error("Ghi GitHub tháº¥t báº¡i");

  await loadData();
}

/* ================== UI ================== */
function show(id){
 ["home","empLogin","empView","adminLogin","adminPanel"]
 .forEach(v=>document.getElementById(v).classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
}
function back(){show("home")}

/* ================== EMPLOYEE ================== */
function loginEmployee(){
 if(!ready) return;

 const name = empName.value.trim().toLowerCase();
 const type = empType.value;
 const pin  = empPin.value;

 const emp = data.employees.find(e=>e.name.toLowerCase()===name);

 if(!emp || emp.type!==type || emp.pin!==pin){
  alert("ThÃ´ng tin khÃ´ng Ä‘Ãºng"); return;
 }
 if(!emp.codes.length){
  alert("ChÆ°a Ä‘Æ°á»£c cáº¥p mÃ£"); return;
 }

 show("empView");
 empTitle.innerText = emp.name;
 empCodes.innerHTML = "";
 emp.codes.forEach(c=>{
  const d=document.createElement("div");
  d.className="code"; d.innerText=c;
  empCodes.appendChild(d);
 });

 confirmBtn.disabled = emp.received;
}

/* ================== CONFIRM ================== */
async function confirmReceived(){
 if(!ready) return;

 const name = empTitle.innerText;
 const emp = data.employees.find(e=>e.name===name);
 if(emp.received) return;

 emp.received = true;
 emp.receivedAt = new Date().toISOString();
 await saveToGitHub(`NhÃ¢n viÃªn ${emp.name} xÃ¡c nháº­n Ä‘Ã£ nháº­n`);
 alert("ÄÃ£ xÃ¡c nháº­n");
}

/* ================== ADMIN ================== */
function loginAdmin(){
 if(adminPin.value!=="2005"){
  alert("Sai PIN"); return;
 }
 show("adminPanel");
 renderAdmin();
}

async function distribute(){
 if(!ready) return;

 let codes=[...new Set(
  codesInput.value.split(/\n+/).map(c=>c.trim()).filter(Boolean)
 )];

 let need = data.employees.reduce((s,e)=>s+e.need,0);
 if(codes.length < need){
  alert("KhÃ´ng Ä‘á»§ mÃ£"); return;
 }

 for(let i=codes.length-1;i>0;i--){
  const j=Math.floor(Math.random()*(i+1));
  [codes[i],codes[j]]=[codes[j],codes[i]];
 }

 let idx=0;
 data.employees.forEach(e=>{
  e.codes = codes.slice(idx, idx+e.need);
  idx += e.need;
 });

 data.status="distributed";
 await saveToGitHub("Quáº£n lÃ½ phÃ¢n bá»• Partner Treat");
 alert("ÄÃ£ phÃ¢n bá»•");
}

/* ================== RENDER ADMIN ================== */
function renderAdmin(){
 adminResult.innerHTML="";
 data.employees.forEach(e=>{
  const h=document.createElement("h4");
  h.innerText = e.name + (e.received?" âœ…":" â³");
  adminResult.appendChild(h);
 });
}

/* ================== INIT ================== */
loadData().catch(err=>{
 alert("Lá»—i táº£i dá»¯ liá»‡u. Kiá»ƒm tra token GitHub.");
 console.error(err);
});
</script>

</body>
</html>



